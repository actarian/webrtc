/**
 * @license webrtc v1.0.0
 * (c) 2021 Luca Zampetti <lzampetti@gmail.com>
 * License: MIT
 */
!function(e,n){"object"==typeof exports&&"undefined"!=typeof module?n(require("rxcomp"),require("rxjs/operators"),require("rxjs")):"function"==typeof define&&define.amd?define(["rxcomp","rxjs/operators","rxjs"],n):n((e="undefined"!=typeof globalThis?globalThis:e||self).rxcomp,e.rxjs.operators,e.rxjs)}(this,(function(e,n,t){"use strict";function o(e,n){for(var t=0;t<n.length;t++){var o=n[t];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(e,o.key,o)}}function i(e,n,t){return n&&o(e.prototype,n),t&&o(e,t),e}function r(e,n,t){return n in e?Object.defineProperty(e,n,{value:t,enumerable:!0,configurable:!0,writable:!0}):e[n]=t,e}function s(e,n){e.prototype=Object.create(n.prototype),e.prototype.constructor=e,a(e,n)}function a(e,n){return(a=Object.setPrototypeOf||function(e,n){return e.__proto__=n,e})(e,n)}var c=function(){function e(){}return e.in=function(n){e.in$.next(n)},e.out=function(n){e.out$.next(n)},e.send=function(n){e.out$.next(n)},e.sendBack=function(n){n=Object.assign({},n,{clientId:n.remoteId,remoteId:n.clientId}),e.out$.next(n)},e.broadcast=function(n){n.broadcast=!0,e.out$.next(n)},e}();r(c,"in$",new t.ReplaySubject(1)),r(c,"out$",new t.ReplaySubject(1));var u=function(){function e(){}return e.getUserMedia=function(){return new Promise((function(n,t){navigator.mediaDevices.getUserMedia({audio:!0,video:{width:{min:320,ideal:640,max:640},height:{min:240,ideal:480,max:480}}}).then((function(t){e.stream=t,n(t)})).catch((function(e){console.log("UserMediaService.getUserMedia.error",e),t(e)}))}))},e}();r(u,"stream",null);var d={iceServers:[{urls:"stun:stunserver.org"},{urls:"stun:stun.ekiga.net"},{urls:"stun:stun.ideasip.com"},{urls:"stun:stun.iptel.org"},{urls:"stun:stun.rixtelecom.se"},{urls:"stun:stun.schlund.de"},{urls:"stun:stun.softjoys.com"},{urls:"stun:stun.voiparound.com"},{urls:"stun:stun.voipbuster.com"},{urls:"stun:stun.voipstunt.com"}]},f={offerToReceiveAudio:!0,offerToReceiveVideo:!0},l=function(){function e(o,i,s){var a=this;void 0===i&&(i=null),void 0===s&&(s=null),r(this,"remote$",new t.BehaviorSubject(null)),this.uid=i||e.getUniqueUserId(),this.remoteId=s,this.stream=o||new MediaStream,this.onIceCandidate=this.onIceCandidate.bind(this),this.onIceConnectionStateChange=this.onIceConnectionStateChange.bind(this),this.onIceGatheringStateChange=this.onIceGatheringStateChange.bind(this),this.onSignalingStateChange=this.onSignalingStateChange.bind(this),this.onNegotiationceNeeded=this.onNegotiationceNeeded.bind(this),this.onTrack=this.onTrack.bind(this);var u=this.connection=new RTCPeerConnection(d);o&&o.getTracks().forEach((function(e){return u.addTrack(e,o)})),u.addEventListener("icecandidate",this.onIceCandidate),u.addEventListener("iceconnectionstatechange",this.onIceConnectionStateChange),u.addEventListener("icegatheringstatechange",this.onIceGatheringStateChange),u.addEventListener("signalingstatechange",this.onSignalingStateChange),u.addEventListener("negotiationneeded",this.onNegotiationceNeeded),u.addEventListener("track",this.onTrack),c.in$.pipe(n.filter((function(e){return e.uid!==a.uid}))).subscribe((function(e){switch(e.type){case"candidate":a.onMessageCandidate(e);break;case"answer":a.onMessageAnswer(e)}}))}var o=e.prototype;return o.dispose=function(){this.remote$.next(null);var e=this.connection;e.removeEventListener("icecandidate",this.onIceCandidate),e.removeEventListener("iceconnectionstatechange",this.onIceConnectionStateChange),e.removeEventListener("icegatheringstatechange",this.onIceGatheringStateChange),e.removeEventListener("signalingstatechange",this.onSignalingStateChange),e.removeEventListener("negotiationneeded",this.onNegotiationceNeeded),e.removeEventListener("track",this.onTrack),e.close(),this.connection=null},o.onIceCandidate=function(e){var n=e.candidate;n&&c.send({type:"candidate",candidate:n,uid:this.uid,remoteId:this.remoteId})},o.onIceConnectionStateChange=function(e){switch(console.log("WebRTCClient.onIceConnectionStateChange",this.connection.iceConnectionState),this.connection.iceConnectionState){case"closed":case"failed":case"disconnected":this.dispose()}},o.onIceGatheringStateChange=function(e){console.log("WebRTCClient.onIceGatheringStateChange",this.connection.iceGatheringState)},o.onSignalingStateChange=function(e){switch(this.connection.signalingState){case"closed":this.dispose()}},o.onNegotiationceNeeded=function(e){var n=this;this.connection.createOffer(f).then((function(e){n.connection.setLocalDescription(e).then((function(e){c.send({type:"offer",description:n.connection.localDescription,uid:n.uid,remoteId:n.remoteId})}))}),(function(e){return n.onCreateOfferReject(e)}))},o.onTrack=function(e){var n=e.streams[0];console.log("WebRTCClient.onTrack",n),this.remote$.next(n)},o.sendOffer=function(){var e=this;this.connection.createOffer(f).then((function(n){e.connection.setLocalDescription(n).then((function(n){c.send({type:"offer",description:e.connection.localDescription,uid:e.uid,remoteId:e.remoteId})}))}),(function(n){return e.onCreateOfferReject(n)}))},o.onMessageCandidate=function(e){e.uid===this.remoteId&&this.connection.addIceCandidate(e.candidate).then((function(){}),this.onAddIceCandidateReject)},o.onMessageOffer=function(e){var n=this;if(e.uid===this.remoteId){var t=new RTCSessionDescription(e.description);"stable"==this.connection.signalingState?this.connection.setRemoteDescription(t).then((function(e){n.connection.createAnswer().then((function(e){n.connection.setLocalDescription(e).then((function(e){c.send({type:"answer",description:n.connection.localDescription,uid:n.uid,remoteId:n.remoteId})}))}),(function(e){return n.onCreateAnswerReject(e)}))})).catch((function(e){console.log("WebRTCClient.onMessageOffer.setRemoteDescription.error",e)})):Promise.all([this.connection.setLocalDescription({type:"rollback"}),this.connection.setRemoteDescription(t).catch((function(e){console.log("WebRTCClient.onMessageOffer.setRemoteDescription.error",e)}))])}},o.onMessageAnswer=function(e){e.uid===this.remoteId&&this.connection.setRemoteDescription(new RTCSessionDescription(e.description)).catch((function(e){console.log("WebRTCClient.onMessageAnswer.setRemoteDescription.error",e)}))},o.onAddIceCandidateReject=function(e){console.log("WebRTCClient.onAddIceCandidateReject.error",e)},o.onCreateOfferReject=function(e){console.log("WebRTCClient.onCreateOfferReject.error",e)},o.onCreateAnswerReject=function(e){console.log("WebRTCClient.onCreateAnswerReject.error",e)},e.call=function(n,t,o){return void 0===t&&(t=null),void 0===o&&(o=null),new e(n,t,o)},e.answer=function(n,t,o){return void 0===t&&(t=null),void 0===o&&(o=null),new e(n,t,o)},e.getUniqueUserId=function(){return(1e13*(100*(1+Math.floor(8*Math.random()))+10*(1+Math.floor(8*Math.random()))+1*(1+Math.floor(8*Math.random())))+Date.now()).toString()},e}(),h=function(){function e(){}return e.addPeer=function(e,n,t){var o=this.peers$.getValue().slice();if(-1!==o.reduce((function(e,n,o){return n.remoteId===t?o:e}),-1))return null;var i=new l(e,n,t);return o.push(i),this.peers$.next(o),this.switchRemotes(),i},e.addPeers=function(e,n,t){var o=this.peers$.getValue().slice();t.forEach((function(t){var i=new l(e,n,t);o.push(i)})),this.peers$.next(o),this.switchRemotes()},e.removePeer=function(e){var n=this.peers$.getValue().slice(),t=n.reduce((function(n,t,o){return t.remoteId===e?o:n}),-1);-1!==t&&(n[t].dispose(),n.splice(t,1),this.peers$.next(n),this.switchRemotes())},e.switchRemotes=function(){var n=this.peers$.getValue().slice().map((function(e){return e.remote$})),o=n.length?t.combineLatest(n):t.of([]);e.remotes$.next(o)},e}();r(h,"remotes$",(new t.ReplaySubject).pipe(n.switchAll())),r(h,"peers$",new t.BehaviorSubject([]));var g=function(){function e(){}return e.connect=function(e,n){void 0===e&&(e=null),void 0===n&&(n=null),e=e||this.getUniqueUserId(),this.uid=e,this.onMessageCallback=n,this.onOpen=this.onOpen.bind(this),this.onClose=this.onClose.bind(this),this.onMessage=this.onMessage.bind(this);var t=location.origin.replace(/^https/,"wss").replace(/^http/,"ws"),o=this.socket=new WebSocket(t);o.addEventListener("open",this.onOpen),o.addEventListener("close",this.onClose),o.addEventListener("message",this.onMessage)},e.disconnect=function(){var e=this.socket;e&&(e.close(),this.socket=null)},e.onOpen=function(e){var n={type:"socketConnected"};this.message$.next(n),"function"==typeof this.onMessageCallback&&this.onMessageCallback(n)},e.onClose=function(e){var n={type:"socketDisconnected"};this.message$.next(n),"function"==typeof this.onMessageCallback&&this.onMessageCallback(n)},e.onMessage=function(n){var t=JSON.parse(n.data);t.remoteId&&(t.sendBack=function(n){void 0===n&&(n={});var o=Object.assign({},t,n,{uid:t.remoteId,remoteId:t.uid});e.send(o)}),"function"==typeof this.onMessageCallback&&this.onMessageCallback(t),this.message$.next(t)},e.send=function(n,t){void 0===n&&(n={});var o=e.socket;n.uid=this.uid,n.timeStamp=Date.now(),t&&(n.broadcast=!0),o.send(JSON.stringify(n))},e.sendAll=function(n){void 0===n&&(n={}),e.send(n,!0)},e.getUniqueUserId=function(){return(1e13*(100*(1+Math.floor(8*Math.random()))+10*(1+Math.floor(8*Math.random()))+1*(1+Math.floor(8*Math.random())))+Date.now()).toString()},e}();r(g,"message$",new t.ReplaySubject(1));var p=function(t){function o(){return t.apply(this,arguments)||this}s(o,t);var r=o.prototype;return r.onInit=function(){var t=this;e.getContext(this).node.classList.remove("hidden"),this.local=null,this.uid=null,this.peers=[],this.remotes=[],this.streams=[],c.in$.pipe(n.tap((function(e){switch(e.type){case"socketConnected":t.onSocketConnected();break;case"joined":t.onJoined(e.peerId);break;case"leaved":break;case"peers":t.onPeers(e.peers);break;case"peerJoined":e.peerId!==t.uid&&t.onPeerJoined(e.peerId);break;case"peerLeaved":e.peerId!==t.uid&&t.onPeerLeaved(e.peerId);break;case"peerInfo":case"peerInfos":break;case"offer":t.onOffer(e)}}))).subscribe(),c.out$.pipe(n.filter((function(e){return e.type,!0})),n.tap((function(e){return g.send(e)}))).subscribe(),h.remotes$.pipe(n.takeUntil(this.unsubscribe$)).subscribe((function(e){t.remotes=e,t.pushChanges()}))},r.onJoin=function(e){var n=this;this.uid||u.getUserMedia().then((function(e){n.local=e,n.pushChanges(),g.connect(null,(function(e){return c.in(e)}))}))},r.onSocketConnected=function(){c.out({type:"join",uid:g.uid,info:{firstName:"Jhon",lastName:"Appleseed"}})},r.onJoined=function(e){this.uid=g.uid=e,this.pushChanges(),g.send({type:"peers",uid:g.uid})},r.onPeers=function(e){this.peers=e,h.addPeers(this.local,this.uid,this.remotePeers),this.pushChanges()},r.onPeerJoined=function(e){-1===this.peers.indexOf(e)&&(this.peers.push(e),this.pushChanges())},r.onPeerLeaved=function(e){var n=this.peers.indexOf(e);-1!==n&&(this.peers.splice(n,1),this.pushChanges()),h.removePeer(e)},r.onCall=function(e){},r.onOffer=function(e){var n=h.addPeer(this.local,this.uid,e.uid);null!=n&&n.onMessageOffer(e)},i(o,[{key:"remotePeers",get:function(){var e=this;return(this.peers||[]).filter((function(n){return n!==e.uid}))}}]),o}(e.Component);p.meta={selector:"[app-component]"};var m=function(){function e(){}return e.merge=function(e,n){var t=this;return"object"==typeof n&&Object.keys(n).forEach((function(o){var i=n[o];"object"!=typeof i||Array.isArray(i)?e[o]=i:e[o]=t.merge(e[o],i)})),e},e}(),v="undefined"!=typeof module&&module.exports,b=((v?{get:function(){}}:new URLSearchParams(window.location.search)).get("debug"),v?null:document.querySelector("base").getAttribute("href")),C=!v&&(window&&-1!==window.location.host.indexOf("herokuapp")),k=!v&&(C||window&&("41789"===window.location.port||"5000"===window.location.port||"6443"===window.location.port||"actarian.github.io"===window.location.host)),w=!v&&(window&&-1!==["localhost","127.0.0.1","0.0.0.0"].indexOf(window.location.host.split(":")[0])),y={STATIC:k,DEVELOPMENT:w,PRODUCTION:!w},I=function(){var e=n.prototype;function n(e){if(e){if("object"==typeof e.url){var n=e.language||"",t=e.market||"";Object.keys(e.url).forEach((function(o){e.url[o]=n+t+e.url[o]}))}Object.assign(this,e)}}return e.getAbsoluteUrl=function(e,n){var t=""+window.location.origin+e;return Object.keys(n).forEach((function(e){t=t.replace("$"+e,n[e])})),t},e.getPath=function(e){return this.isLocal(e)?this.href+e:e},e.isLocal=function(e){return-1===e.indexOf("://")},i(n,[{key:"STATIC",get:function(){return y.STATIC},set:function(e){y.STATIC=!0===e||"true"===e}},{key:"href",get:function(){return C?this.githubDocs:b}}]),n}(),S={channelName:"BHere",flags:{production:!1,useProxy:!1,useToken:!1,selfService:!0,guidedTourRequest:!0,editor:!0,ar:!0,menu:!0,attendee:!0,streamer:!0,viewer:!0,smartDevice:!0,maxQuality:!1,heroku:C}},O=window.STATIC?{flags:{production:!1},logo:null,background:{image:"/terranova/img/background.jpg",video:"/terranova/img/background.mp4"},colors:{menuBackground:"#000000",menuForeground:"#ffffff",menuOverBackground:"#0099ff",menuOverForeground:"#ffffff",menuBackBackground:"#0099ff",menuBackForeground:"#000000",menuBackOverBackground:"#0099ff",menuBackOverForeground:"#ffffff"},assets:"/terranova/",worker:"./js/workers/image.service.worker.js",githubDocs:"https://raw.githubusercontent.com/actarian/terranova/main/docs/",url:{index:"/"},languages:["en"],defaultLanguage:"en"}:{flags:{production:!0},logo:null,background:{image:"/Client/docs/img/background.jpg",video:"/Client/docs/img/background.mp4"},colors:{menuBackground:"#000000",menuForeground:"#ffffff",menuOverBackground:"#0099ff",menuOverForeground:"#ffffff",menuBackBackground:"#0099ff",menuBackForeground:"#000000",menuBackOverBackground:"#0099ff",menuBackOverForeground:"#ffffff"},assets:"/Client/docs/",worker:"/Client/docs/js/workers/image.service.worker.js",githubDocs:"https://raw.githubusercontent.com/actarian/terranova/main/docs/",url:{index:"/"},languages:["en"],defaultLanguage:"en"},j=Object.assign({port:5e3,fontFamily:"GT Walsheim, sans-serif",colors:{menuBackground:"#000000",menuForeground:"#ffffff",menuOverBackground:"#0099ff",menuOverForeground:"#ffffff",menuBackBackground:"#0099ff",menuBackForeground:"#000000",menuBackOverBackground:"#0099ff",menuBackOverForeground:"#ffffff"},editor:{disabledViewTypes:["waiting-room","room-3d"],disabledViewItemTypes:["texture"]},renderOrder:{panorama:0,model:10,plane:20,tile:30,banner:40,nav:50,panel:60,menu:70,debug:80,pointer:90}},S,O),M=new I(j=m.merge(j,window.bhere));console.log("environment",M);var R=function(e){function n(){return e.apply(this,arguments)||this}return s(n,e),n.transform=function(e){return M.flags[e]||!1},n}(e.Pipe);R.meta={name:"flag"};var T=function(n){function t(){return n.apply(this,arguments)||this}return s(t,n),t.prototype.onChanges=function(){var n=e.getContext(this).node.querySelector("video");n.srcObject!==this.stream&&(n.srcObject=this.stream)},t}(e.Component);T.meta={selector:"[webrtc-stream]",inputs:["stream"],template:'\n\t\t<div class="webrtc-stream">\n\t\t\t<video playsinline autoplay muted></video>\n\t\t</div>\n\t'};var x=function(e){function n(){return e.apply(this,arguments)||this}return s(n,e),n}(e.Module);x.meta={imports:[e.CoreModule],declarations:[R,T],bootstrap:p},e.Browser.bootstrap(x)}));
//# sourceMappingURL=main.min.js.map